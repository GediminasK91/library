{% load dict_get %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Library Books</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body { background: #f5f6fa; }
        .book-card {
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(80,107,204,0.1);
            border: none;
            background: #fff;
            transition: box-shadow 0.2s;
            margin-bottom: 15px;
        }
        .book-card:hover { box-shadow: 0 2px 16px rgba(80,107,204,0.15); }
        .qr-code-img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }
        .book-status { font-weight: bold; font-size: 0.9rem; }
        .taken { color: #c85454; }
        .available { color: #39a964; }
        .no-qr {
            background-color: #adb5bd;
            color: #fff;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            margin: 0 auto 1rem auto;
            font-size: 1.1em;
            letter-spacing: 2px;
        }
        .btn-print-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            align-items: center;
            margin-top: 0.5rem;
        }
        .owner-label {
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary rounded-bottom mb-4">
    <div class="container">
        <span class="navbar-brand">Company Library</span>

        <div class="ms-auto">
            {% if request.user.is_authenticated %}
                <span class="text-white me-3">
                    {{ request.user.get_full_name|default:request.user.username }}
                </span>
                <a class="btn btn-outline-light btn-sm" href="{% url 'logout' %}">Logout</a>
            {% else %}
                <a class="btn btn-outline-light btn-sm" href="{% url 'login' %}">Login</a>
            {% endif %}
        </div>
    </div>
</nav>

<div class="container">
    <!-- Add Book Form -->
    <form method="post" class="mb-4 p-3 border rounded bg-light">
        {% csrf_token %}
        <div class="row g-2 align-items-center">
            <div class="col-12 col-md-4">
                <input type="text" name="title" class="form-control" placeholder="Book title" required />
            </div>
            <div class="col-12 col-md-3">
                <input type="text" name="author" class="form-control" placeholder="Author" required />
            </div>
            <div class="col-12 col-md-3">
                <select name="owner_id" class="form-select">
                    <option value="">Owner (optional)</option>
                    {% for u in users %}
                        <option value="{{ u.id }}">
                            {% if u.get_full_name %}{{ u.get_full_name }}{% else %}{{ u.username }}{% endif %}
                            {% if u.email %} ({{ u.email }}){% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-2">
                <button type="submit" class="btn btn-primary w-100">Add Book</button>
            </div>
        </div>
    </form>

    <div class="row">
        {% for book in books %}
        <div class="col-12 col-sm-6 col-md-4">
            <div class="card book-card p-3">

                <a href="{% url 'take_book_page' book.id %}">
                    {% if book.qr_code %}
                        <img src="{{ book.qr_code.url }}" alt="QR for {{ book.title }}" class="qr-code-img mb-3" />
                    {% else %}
                        <div class="no-qr">No QR</div>
                    {% endif %}
                </a>

                {% if book.qr_code %}
                <div class="btn-print-group">
                    <a href="{{ book.qr_code.url }}" target="_blank" class="btn btn-outline-secondary btn-sm">Print QR Image</a>
                    <a href="{% url 'print_qr' book.id %}" target="_blank" class="btn btn-outline-secondary btn-sm">Print Pretty QR</a>
                </div>
                {% endif %}

                <h5 class="text-center mt-3">{{ book.title }}</h5>
                <div class="text-center mb-2 text-muted" style="font-size:0.96em;">by {{ book.author }}</div>

                {% if book.owner %}
                    <div class="text-center owner-label mb-2">
                        <strong>Owner:</strong>
                        {{ book.owner.get_full_name|default:book.owner.username }}
                        {% if book.owner.email %} ({{ book.owner.email }}){% endif %}
                    </div>
                {% else %}
                    <div class="text-center owner-label mb-2"><em>No owner assigned</em></div>
                {% endif %}

                {% if book.id in loaned_books %}
                    {% with loan=loan_info|dict_get:book.id %}
                        <div class="text-center mb-2 book-status taken">
                            Taken by {{ loan.user_email }} since {{ loan.taken_at|date:"M d" }}
                        </div>
                        <form action="{% url 'return_book' book.id %}" method="post" class="d-flex justify-content-center">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-warning btn-sm">Return</button>
                        </form>
                    {% endwith %}
                {% else %}
                    <div class="text-center book-status available">Available</div>
                {% endif %}

            </div>
        </div>
        {% empty %}
            <p>No books found.</p>
        {% endfor %}
    </div>
</div>
</body>
</html>
